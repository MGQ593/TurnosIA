{
  "version": 3,
  "sources": ["../../src/frontend/confirmacion.ts"],
  "sourcesContent": ["import type { ApiResponse } from './types';\r\n\r\n// ==========================================\r\n// Interfaces\r\n// ==========================================\r\ninterface PublicConfig {\r\n  logoUrl: string;\r\n  expirationMinutes: number;\r\n  asignacionDisplayTimeSeconds: number;\r\n}\r\n\r\ninterface TokenVerificationResponse {\r\n  success: boolean;\r\n  turnoId: string;\r\n  expiresAt?: string;\r\n}\r\n\r\n// ==========================================\r\n// Constantes\r\n// ==========================================\r\nconst PUBLIC_CONFIG_ENDPOINT = '/api/config/public';\r\nconst DEFAULT_LOGO_URL = 'https://www.chevyplan.com.ec/wp-content/uploads/2025/10/wb_chevyplan_logo-financiamiento-w_v5.webp';\r\n\r\nlet EXPIRATION_MINUTES = 1; // Default\r\nlet ASIGNACION_DISPLAY_TIME_SECONDS = 3; // Default - Tiempo en segundos antes de redirigir\r\n\r\n// ==========================================\r\n// Variables de Audio y Notificaciones\r\n// ==========================================\r\nlet audioContext: AudioContext | null = null;\r\nlet audioHabilitado = false;\r\nlet audioBuffer: AudioBuffer | null = null;\r\nlet notificacionesPushHabilitadas = false;\r\n\r\n// ==========================================\r\n// Elementos del DOM\r\n// ==========================================\r\nconst logoImg = document.getElementById('logoImg') as HTMLImageElement | null;\r\nconst turnoDisplay = document.getElementById('turnoDisplay') as HTMLDivElement | null;\r\n\r\n// ==========================================\r\n// Funciones de Utilidad\r\n// ==========================================\r\n\r\n/**\r\n * Obtiene el valor de un par\u00E1metro de la URL\r\n */\r\nfunction obtenerParametroURL(nombre: string): string | null {\r\n  const urlParams = new URLSearchParams(window.location.search);\r\n  return urlParams.get(nombre);\r\n}\r\n\r\n/**\r\n * Carga la configuraci\u00F3n p\u00FAblica del servidor\r\n */\r\nasync function cargarConfiguracion(): Promise<void> {\r\n  try {\r\n    const respuesta = await fetch(PUBLIC_CONFIG_ENDPOINT, { cache: 'no-store' });\r\n    \r\n    if (respuesta.ok) {\r\n      const data: PublicConfig = await respuesta.json();\r\n      \r\n      // Cargar logo\r\n      if (logoImg && data.logoUrl) {\r\n        logoImg.src = data.logoUrl;\r\n        logoImg.onerror = () => {\r\n          console.warn('Error cargando logo desde configuraci\u00F3n');\r\n          if (logoImg) logoImg.src = DEFAULT_LOGO_URL;\r\n        };\r\n      }\r\n      \r\n      // Cargar tiempo de expiraci\u00F3n\r\n      if (data.expirationMinutes) {\r\n        EXPIRATION_MINUTES = data.expirationMinutes;\r\n        console.log('\u23F1\uFE0F Tiempo de expiraci\u00F3n:', EXPIRATION_MINUTES, 'minutos');\r\n      }\r\n      \r\n      // Cargar tiempo de visualizaci\u00F3n de asignaci\u00F3n\r\n      if (data.asignacionDisplayTimeSeconds) {\r\n        ASIGNACION_DISPLAY_TIME_SECONDS = data.asignacionDisplayTimeSeconds;\r\n        console.log('\u23F1\uFE0F Tiempo de visualizaci\u00F3n de asignaci\u00F3n:', ASIGNACION_DISPLAY_TIME_SECONDS, 'segundos');\r\n      }\r\n    }\r\n  } catch (error) {\r\n    console.error('Error cargando configuraci\u00F3n:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Verifica y decodifica el token JWT\r\n */\r\nasync function verificarToken(token: string): Promise<TokenVerificationResponse | null> {\r\n  try {\r\n    const response = await fetch(`/api/token/verificar-token/${encodeURIComponent(token)}`);\r\n    const data: TokenVerificationResponse = await response.json();\r\n    \r\n    if (data.success) {\r\n      console.log('\u2705 Token v\u00E1lido:', data);\r\n      return data;\r\n    } else {\r\n      console.warn('\uD83D\uDEAB Token inv\u00E1lido o expirado');\r\n      return null;\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Error verificando token:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Muestra una p\u00E1gina de error con el mensaje proporcionado\r\n */\r\nfunction mostrarErrorToken(mensaje: string): void {\r\n  document.body.innerHTML = `\r\n    <style>\r\n      @keyframes float {\r\n        0%, 100% { transform: translate(0, 0) scale(1); }\r\n        50% { transform: translate(25px, 25px) scale(1.05); }\r\n      }\r\n      \r\n      @media (max-width: 768px) {\r\n        .error-container {\r\n          padding: 24px 16px !important;\r\n        }\r\n        .error-card {\r\n          padding: 32px 24px !important;\r\n          max-width: 100% !important;\r\n          width: calc(100vw - 32px) !important;\r\n        }\r\n        .error-logo {\r\n          max-width: 180px !important;\r\n          margin-bottom: 24px !important;\r\n        }\r\n        .error-icon {\r\n          font-size: 56px !important;\r\n        }\r\n        .error-title {\r\n          font-size: 24px !important;\r\n        }\r\n        .error-text {\r\n          font-size: 15px !important;\r\n        }\r\n      }\r\n    </style>\r\n    <div class=\"error-container\" style=\"\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      flex-direction: column;\r\n      height: 100vh;\r\n      background: #02539A;\r\n      text-align: center;\r\n      padding: 40px 20px;\r\n      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      right: 0;\r\n      bottom: 0;\r\n      overflow: hidden;\r\n    \">\r\n      <div class=\"error-card\" style=\"\r\n        background: rgba(255, 255, 255, 0.96);\r\n        backdrop-filter: blur(20px);\r\n        padding: 48px;\r\n        border-radius: 24px;\r\n        border: 1px solid rgba(148, 163, 184, 0.35);\r\n        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.25);\r\n        color: #0f172a;\r\n        max-width: 500px;\r\n        width: 100%;\r\n        position: relative;\r\n        z-index: 1;\r\n      \">\r\n        <img \r\n          class=\"error-logo\"\r\n          src=\"${DEFAULT_LOGO_URL}\" \r\n          alt=\"ChevyPlan Logo\" \r\n          style=\"\r\n            max-width: 200px;\r\n            width: 100%;\r\n            height: auto;\r\n            margin: 0 auto 32px;\r\n            display: block;\r\n          \"\r\n        >\r\n        <div class=\"error-icon\" style=\"font-size: 64px; margin-bottom: 24px;\">\uD83D\uDEAB</div>\r\n        <h1 class=\"error-title\" style=\"margin-bottom: 16px; font-size: 28px; font-weight: 700; color: #0f172a;\">Acceso Denegado</h1>\r\n        <p class=\"error-text\" style=\"margin-bottom: 0; color: #475569; line-height: 1.6; font-size: 16px;\">\r\n          ${mensaje}\r\n        </p>\r\n      </div>\r\n    </div>\r\n  `;\r\n}\r\n\r\n/**\r\n * Muestra la p\u00E1gina de sesi\u00F3n finalizada\r\n */\r\nfunction mostrarSesionFinalizada(): void {\r\n  document.body.innerHTML = `\r\n    <style>\r\n      @keyframes float {\r\n        0%, 100% { transform: translate(0, 0) scale(1); }\r\n        50% { transform: translate(25px, 25px) scale(1.05); }\r\n      }\r\n    </style>\r\n    <div style=\"\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      flex-direction: column;\r\n      height: 100vh;\r\n      background: #02539A;\r\n      text-align: center;\r\n      padding: 40px 20px;\r\n      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;\r\n      position: fixed;\r\n      top: 0;\r\n      left: 0;\r\n      right: 0;\r\n      bottom: 0;\r\n      overflow: hidden;\r\n    \">\r\n      \r\n      <img \r\n        src=\"${DEFAULT_LOGO_URL}\" \r\n        alt=\"ChevyPlan Logo\" \r\n        style=\"\r\n          max-width: 220px;\r\n          height: auto;\r\n          margin-bottom: 32px;\r\n          position: relative;\r\n          z-index: 1;\r\n          filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.2));\r\n        \"\r\n      >\r\n      \r\n      <div style=\"\r\n        background: rgba(255, 255, 255, 0.96);\r\n        backdrop-filter: blur(20px);\r\n        padding: 48px;\r\n        border-radius: 24px;\r\n        border: 1px solid rgba(148, 163, 184, 0.35);\r\n        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.25);\r\n        color: #0f172a;\r\n        max-width: 420px;\r\n        width: 100%;\r\n        position: relative;\r\n        z-index: 1;\r\n      \">\r\n        <div style=\"font-size: 64px; margin-bottom: 24px;\">\u2705</div>\r\n        <h1 style=\"margin-bottom: 16px; font-size: 28px; font-weight: 700;\">Sesi\u00F3n Finalizada</h1>\r\n        <p style=\"margin-bottom: 24px; color: #475569; line-height: 1.6; font-size: 16px;\">\r\n          Tu turno ha sido procesado. Gracias por usar nuestro sistema.\r\n        </p>\r\n        <p style=\"font-size: 14px; color: #64748b; margin-bottom: 8px;\">\r\n          Esta ventana se cerrar\u00E1 autom\u00E1ticamente en <span id=\"countdown\">15</span> segundos.\r\n        </p>\r\n        <p style=\"font-size: 12px; color: #94a3b8; margin-bottom: 0;\">\r\n          Tambi\u00E9n puedes cerrar esta ventana manualmente.\r\n        </p>\r\n      </div>\r\n    </div>\r\n  `;\r\n\r\n  // Iniciar cuenta regresiva y cerrar ventana despu\u00E9s de 15 segundos\r\n  let segundosRestantes = 15;\r\n  const countdownElement = document.getElementById('countdown');\r\n  \r\n  const intervalo = setInterval(() => {\r\n    segundosRestantes--;\r\n    if (countdownElement) {\r\n      countdownElement.textContent = segundosRestantes.toString();\r\n    }\r\n    \r\n    if (segundosRestantes <= 0) {\r\n      clearInterval(intervalo);\r\n      cerrarVentana();\r\n    }\r\n  }, 1000);\r\n}\r\n\r\n/**\r\n * Intenta cerrar la ventana/pesta\u00F1a del navegador\r\n */\r\nfunction cerrarVentana(): void {\r\n  console.log('\uD83D\uDEAA Intentando cerrar la ventana...');\r\n  \r\n  // M\u00E9todo 1: Intentar cerrar directamente\r\n  try {\r\n    window.close();\r\n  } catch (error) {\r\n    console.warn('\u26A0\uFE0F No se pudo cerrar con window.close():', error);\r\n  }\r\n  \r\n  // M\u00E9todo 2: Si window.close() no funciona, redirigir a about:blank\r\n  setTimeout(() => {\r\n    if (!window.closed) {\r\n      console.log('\uD83D\uDD04 Redirigiendo a about:blank...');\r\n      window.location.href = 'about:blank';\r\n    }\r\n  }, 500);\r\n}\r\n\r\n// ==========================================\r\n// Funciones de Audio y Notificaciones\r\n// ==========================================\r\n\r\n/**\r\n * Genera un tono de notificaci\u00F3n usando Web Audio API\r\n */\r\nasync function generarTonoNotificacion(): Promise<AudioBuffer | null> {\r\n  try {\r\n    if (!audioContext) {\r\n      audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n    }\r\n\r\n    const sampleRate = audioContext.sampleRate;\r\n    const duration = 0.3; // 300ms\r\n    const buffer = audioContext.createBuffer(1, sampleRate * duration, sampleRate);\r\n    const channel = buffer.getChannelData(0);\r\n\r\n    // Generar un tono agradable (dos notas)\r\n    for (let i = 0; i < channel.length; i++) {\r\n      const t = i / sampleRate;\r\n      const freq1 = 800; // Nota principal\r\n      const freq2 = 1000; // Nota secundaria\r\n      \r\n      // Mezcla de dos frecuencias\r\n      const value = (Math.sin(2 * Math.PI * freq1 * t) * 0.3 + \r\n                     Math.sin(2 * Math.PI * freq2 * t) * 0.3);\r\n      \r\n      // Envelope (fade in/out)\r\n      const envelope = Math.min(t * 10, 1) * Math.max(1 - (t - duration + 0.1) * 10, 0);\r\n      channel[i] = value * envelope;\r\n    }\r\n\r\n    return buffer;\r\n  } catch (error) {\r\n    console.error('\u274C Error generando tono:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Intenta cargar un archivo de audio MP3/OGG\r\n */\r\nasync function cargarArchivoAudio(url: string): Promise<AudioBuffer | null> {\r\n  try {\r\n    if (!audioContext) {\r\n      audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\r\n    }\r\n\r\n    const response = await fetch(url);\r\n    const arrayBuffer = await response.arrayBuffer();\r\n    const buffer = await audioContext.decodeAudioData(arrayBuffer);\r\n    \r\n    console.log('\u2705 Archivo de audio cargado correctamente');\r\n    return buffer;\r\n  } catch (error) {\r\n    console.warn('\u26A0\uFE0F No se pudo cargar el archivo de audio, usando tono generado');\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Inicializa el sistema de audio\r\n */\r\nasync function inicializarAudio(): Promise<void> {\r\n  console.log('\uD83D\uDD0A Inicializando sistema de audio...');\r\n  \r\n  try {\r\n    // Intentar cargar archivo MP3 primero\r\n    audioBuffer = await cargarArchivoAudio('/sounds/notification.mp3');\r\n    \r\n    // Si falla, usar tono generado\r\n    if (!audioBuffer) {\r\n      audioBuffer = await generarTonoNotificacion();\r\n    }\r\n    \r\n    audioHabilitado = true;\r\n    console.log('\u2705 Sistema de audio inicializado');\r\n  } catch (error) {\r\n    console.error('\u274C Error inicializando audio:', error);\r\n    audioHabilitado = false;\r\n  }\r\n}\r\n\r\n/**\r\n * Reproduce el sonido de notificaci\u00F3n\r\n */\r\nfunction reproducirSonido(): void {\r\n  if (!audioHabilitado || !audioBuffer || !audioContext) {\r\n    console.warn('\u26A0\uFE0F Audio no disponible');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    // Reanudar contexto si est\u00E1 suspendido (requerido en iOS)\r\n    if (audioContext.state === 'suspended') {\r\n      audioContext.resume();\r\n    }\r\n\r\n    // Crear fuente de audio\r\n    const source = audioContext.createBufferSource();\r\n    source.buffer = audioBuffer;\r\n    \r\n    // Crear ganancia para controlar volumen\r\n    const gainNode = audioContext.createGain();\r\n    gainNode.gain.value = 0.5; // 50% volumen\r\n    \r\n    // Conectar: source -> gain -> destination\r\n    source.connect(gainNode);\r\n    gainNode.connect(audioContext.destination);\r\n    \r\n    // Reproducir\r\n    source.start(0);\r\n    console.log('\uD83D\uDD0A Sonido reproducido');\r\n  } catch (error) {\r\n    console.error('\u274C Error reproduciendo sonido:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Vibra el dispositivo (solo m\u00F3viles)\r\n */\r\nfunction vibrarDispositivo(): void {\r\n  if ('vibrate' in navigator) {\r\n    try {\r\n      // Patr\u00F3n: vibrar 200ms, pausa 100ms, vibrar 200ms\r\n      navigator.vibrate([200, 100, 200]);\r\n      console.log('\uD83D\uDCF3 Dispositivo vibrando');\r\n    } catch (error) {\r\n      console.warn('\u26A0\uFE0F Vibraci\u00F3n no disponible:', error);\r\n    }\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// Funciones de Notificaciones Push\r\n// ==========================================\r\n\r\n/**\r\n * Verifica si las notificaciones push est\u00E1n soportadas\r\n */\r\nfunction notificacionesSoportadas(): boolean {\r\n  return 'Notification' in window;\r\n}\r\n\r\n/**\r\n * Solicita permisos para notificaciones push\r\n */\r\nasync function solicitarPermisosNotificaciones(): Promise<boolean> {\r\n  if (!notificacionesSoportadas()) {\r\n    console.warn('\u26A0\uFE0F Notificaciones push no soportadas en este navegador');\r\n    return false;\r\n  }\r\n\r\n  try {\r\n    const permiso = await Notification.requestPermission();\r\n    \r\n    if (permiso === 'granted') {\r\n      console.log('\u2705 Permisos de notificaci\u00F3n concedidos');\r\n      notificacionesPushHabilitadas = true;\r\n      return true;\r\n    } else if (permiso === 'denied') {\r\n      console.warn('\u274C Permisos de notificaci\u00F3n denegados');\r\n      notificacionesPushHabilitadas = false;\r\n      return false;\r\n    } else {\r\n      console.log('\u2139\uFE0F Permisos de notificaci\u00F3n no decididos');\r\n      notificacionesPushHabilitadas = false;\r\n      return false;\r\n    }\r\n  } catch (error) {\r\n    console.error('\u274C Error solicitando permisos de notificaci\u00F3n:', error);\r\n    notificacionesPushHabilitadas = false;\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Env\u00EDa una notificaci\u00F3n push\r\n */\r\nfunction enviarNotificacionPush(titulo: string, opciones: NotificationOptions): void {\r\n  if (!notificacionesPushHabilitadas || !notificacionesSoportadas()) {\r\n    console.warn('\u26A0\uFE0F Notificaciones push no habilitadas');\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const notificacion = new Notification(titulo, opciones);\r\n    \r\n    // Reproducir sonido tambi\u00E9n cuando se hace clic en la notificaci\u00F3n\r\n    notificacion.onclick = () => {\r\n      window.focus();\r\n      notificacion.close();\r\n    };\r\n    \r\n    // Auto-cerrar despu\u00E9s de 10 segundos\r\n    setTimeout(() => {\r\n      notificacion.close();\r\n    }, 10000);\r\n    \r\n    console.log('\uD83D\uDCEC Notificaci\u00F3n push enviada');\r\n  } catch (error) {\r\n    console.error('\u274C Error enviando notificaci\u00F3n push:', error);\r\n  }\r\n}\r\n\r\n/**\r\n * Consulta el estado de asignaci\u00F3n del turno (polling)\r\n */\r\nasync function verificarAsignacionTurno(numeroTurno: string, agenciaId: number): Promise<void> {\r\n  console.log(`\uD83D\uDD04 Iniciando polling para turno: ${numeroTurno} de agencia ${agenciaId}`);\r\n  \r\n  const intervalo = setInterval(async () => {\r\n    try {\r\n      console.log(`\uD83D\uDD0D Consultando estado del turno ${numeroTurno} de agencia ${agenciaId}...`);\r\n      \r\n      const response = await fetch(`/api/turnos/estado/${encodeURIComponent(numeroTurno)}?agenciaId=${agenciaId}`);\r\n      const data: ApiResponse<{\r\n        asignado: boolean;\r\n        modulo?: string;\r\n        asesor?: string;\r\n      }> = await response.json();\r\n      \r\n      if (data.success && data.data?.asignado) {\r\n        // Turno asignado - detener polling\r\n        clearInterval(intervalo);\r\n        \r\n        console.log('\u2705 Turno asignado:', data.data);\r\n        \r\n        // Mostrar informaci\u00F3n de asignaci\u00F3n\r\n        mostrarAsignacion(data.data.modulo!, data.data.asesor!);\r\n        \r\n        // Esperar el tiempo configurado para que el usuario vea la informaci\u00F3n antes de redirigir\r\n        const displayTime = ASIGNACION_DISPLAY_TIME_SECONDS * 1000; // Convertir a milisegundos\r\n        console.log(`\u23F1\uFE0F Esperando ${ASIGNACION_DISPLAY_TIME_SECONDS} segundos antes de redirigir...`);\r\n        setTimeout(() => {\r\n          mostrarSesionFinalizada();\r\n        }, displayTime);\r\n      }\r\n    } catch (error) {\r\n      console.error('\u274C Error consultando estado del turno:', error);\r\n    }\r\n  }, 5000); // Cada 5 segundos\r\n}\r\n\r\n/**\r\n * Muestra la informaci\u00F3n de asignaci\u00F3n del turno\r\n */\r\nfunction mostrarAsignacion(modulo: string, asesor: string): void {\r\n  console.log('\uD83C\uDFAF mostrarAsignacion llamada con:', { modulo, asesor });\r\n  \r\n  const asignacionInfo = document.getElementById('asignacion-info');\r\n  const moduloSpan = document.getElementById('modulo');\r\n  const asesorSpan = document.getElementById('asesor');\r\n  \r\n  console.log('\uD83D\uDCCD Elementos encontrados:', {\r\n    asignacionInfo: !!asignacionInfo,\r\n    moduloSpan: !!moduloSpan,\r\n    asesorSpan: !!asesorSpan\r\n  });\r\n  \r\n  if (asignacionInfo && moduloSpan && asesorSpan) {\r\n    moduloSpan.textContent = modulo;\r\n    asesorSpan.textContent = asesor;\r\n    asignacionInfo.style.display = 'block';\r\n    \r\n    console.log('\u2705 Asignaci\u00F3n mostrada correctamente:', {\r\n      modulo: moduloSpan.textContent,\r\n      asesor: asesorSpan.textContent,\r\n      display: asignacionInfo.style.display\r\n    });\r\n\r\n    // Reproducir todas las notificaciones\r\n    reproducirSonido();\r\n    vibrarDispositivo();\r\n    \r\n    // Enviar notificaci\u00F3n push\r\n    enviarNotificacionPush('\uD83C\uDFAB Turno Asignado', {\r\n      body: `Dir\u00EDgete a ${modulo}\\nTe atender\u00E1: ${asesor}`,\r\n      icon: DEFAULT_LOGO_URL,\r\n      badge: DEFAULT_LOGO_URL,\r\n      tag: 'turno-asignado',\r\n      requireInteraction: false,\r\n      silent: false, // Permitir sonido de la notificaci\u00F3n\r\n      data: {\r\n        modulo,\r\n        asesor,\r\n        timestamp: Date.now()\r\n      }\r\n    });\r\n  } else {\r\n    console.error('\u274C No se encontraron todos los elementos necesarios');\r\n  }\r\n}\r\n\r\n/**\r\n * Previene que el usuario retroceda al formulario\r\n */\r\nfunction prevenirRetroceso(): void {\r\n  // Agregar estado al historial para evitar retroceso\r\n  history.pushState(null, '', location.href);\r\n  \r\n  window.addEventListener('popstate', () => {\r\n    history.pushState(null, '', location.href);\r\n  });\r\n}\r\n\r\n// ==========================================\r\n// Inicializaci\u00F3n\r\n// ==========================================\r\n\r\n/**\r\n * Funci\u00F3n principal de inicializaci\u00F3n\r\n */\r\n(async function inicializar(): Promise<void> {\r\n  try {\r\n    // Cargar configuraci\u00F3n primero\r\n    await cargarConfiguracion();\r\n    \r\n    // Obtener token de la URL\r\n    const token = obtenerParametroURL('token');\r\n    \r\n    if (!token) {\r\n      console.warn('No se encontr\u00F3 token en la URL');\r\n      mostrarErrorToken('El enlace no es v\u00E1lido o ha sido modificado. Por favor, solicita un nuevo turno.');\r\n      return;\r\n    }\r\n\r\n    // Verificar el token con el servidor\r\n    const tokenData = await verificarToken(token);\r\n    \r\n    if (!tokenData || !tokenData.success) {\r\n      mostrarErrorToken('El token es inv\u00E1lido, ha expirado o ha sido manipulado. Por favor, solicita un nuevo turno.');\r\n      return;\r\n    }\r\n\r\n    // Token v\u00E1lido - mostrar turno\r\n    if (turnoDisplay) {\r\n      turnoDisplay.textContent = tokenData.turnoId;\r\n      console.log('\uD83C\uDFAB Turno cargado:', tokenData.turnoId);\r\n    }\r\n    \r\n    // Auto-inicializar sistemas de notificaci\u00F3n seg\u00FAn preferencias del usuario\r\n    const activarAudio = (tokenData as any).activarAudio ?? false;\r\n    const activarPush = (tokenData as any).activarPush ?? false;\r\n    // Extraer agenciaId de la URL\r\n    function obtenerParametroURL(nombre: string): string | null {\r\n      const urlParams = new URLSearchParams(window.location.search);\r\n      return urlParams.get(nombre);\r\n    }\r\n    const agenciaIdParam = obtenerParametroURL('id_agencia');\r\n    const agenciaId = agenciaIdParam ? parseInt(agenciaIdParam) : undefined;\r\n    if (!agenciaId || isNaN(agenciaId)) {\r\n      console.error('\u274C URL inv\u00E1lida: falta id_agencia');\r\n      throw new Error('URL inv\u00E1lida: falta id_agencia');\r\n    }\r\n    console.log(`\uD83D\uDCF1 Preferencias de notificaci\u00F3n: Audio=${activarAudio}, Push=${activarPush}`);\r\n    console.log(`\uD83C\uDFE2 Agencia ID (URL): ${agenciaId}`);\r\n    \r\n    if (activarAudio) {\r\n      await inicializarAudio();\r\n      console.log('\u2705 Audio activado autom\u00E1ticamente por preferencias del usuario');\r\n    } else {\r\n      audioHabilitado = false;\r\n      console.log('\u2139\uFE0F Audio desactivado seg\u00FAn preferencias del usuario');\r\n    }\r\n    \r\n    if (activarPush) {\r\n      await solicitarPermisosNotificaciones();\r\n      console.log('\u2705 Push notifications activadas autom\u00E1ticamente por preferencias del usuario');\r\n    } else {\r\n      console.log('\u2139\uFE0F Push notifications desactivadas seg\u00FAn preferencias del usuario');\r\n    }\r\n    \r\n    // Iniciar polling para verificar asignaci\u00F3n\r\n    verificarAsignacionTurno(tokenData.turnoId, agenciaId);\r\n    \r\n    // Prevenir retroceso\r\n    prevenirRetroceso();\r\n    \r\n  } catch (error) {\r\n    console.error('\u274C Error en inicializaci\u00F3n:', error);\r\n    mostrarErrorToken('Ocurri\u00F3 un error al procesar tu turno. Por favor, intenta nuevamente.');\r\n  }\r\n})();\r\n"],
  "mappings": "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",
  "names": ["obtenerParametroURL"]
}
