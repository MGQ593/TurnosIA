// Constantes
const DEFAULT_LOGO_URL = 'https://www.chevyplan.com.ec/wp-content/uploads/2025/10/wb_chevyplan_logo-financiamiento-w_v5.webp';
const PUBLIC_CONFIG_ENDPOINT = '/api/config/public';
const TURNO_STORAGE_KEY = 'turno_actual';
const RATE_LIMIT_MS = 3000; // 3 segundos entre env√≠os

// Variables DOM
const form = document.getElementById('turnoForm');
const loading = document.getElementById('loading');
const formShell = document.getElementById('formShell');
const successMessage = document.getElementById('successMessage');
const alertContainer = document.getElementById('alertContainer');
const turnoIdMensaje = document.getElementById('turnoIdMensaje');
const turnoIdElemento = document.getElementById('turnoId');
const submitBtn = document.getElementById('submitBtn');
const cedulaInput = document.getElementById('cedula');
const celularInput = document.getElementById('celular');
const logoImg = document.getElementById('brandLogo');
const headerElement = document.querySelector('.header');

// Variables de control
let lastSubmitTime = 0;

// Variables de configuraci√≥n (se cargar√°n desde el servidor)
let RESET_PARAM = 'nuevo';
let EXPIRATION_MINUTES = 30;
let WHATSAPP_API_URL = '';
let WHATSAPP_API_TOKEN = '';

// Obtener par√°metros de URL
function obtenerParametroURL(nombre) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(nombre);
}

// Verificar si el turno ha expirado
function turnoHaExpirado(timestamp) {
    const ahora = new Date().getTime();
    const tiempoTurno = new Date(timestamp).getTime();
    const diferenciaMinutos = (ahora - tiempoTurno) / (1000 * 60);
    return diferenciaMinutos >= EXPIRATION_MINUTES;
}

// Verificar si hay un turno guardado al cargar la p√°gina
function verificarTurnoGuardado() {
    try {
        const resetParam = obtenerParametroURL('nuevo');
        const turnoGuardado = localStorage.getItem(TURNO_STORAGE_KEY);
        
        if (turnoGuardado) {
            const turnoData = JSON.parse(turnoGuardado);
            
            // Si viene con par√°metro de reset y el par√°metro es correcto
            if (resetParam === 'true') {
                // Verificar si ha expirado el tiempo
                if (turnoHaExpirado(turnoData.timestamp)) {
                    // Tiempo expirado, limpiar y permitir nuevo turno
                    localStorage.removeItem(TURNO_STORAGE_KEY);
                    console.log('‚úÖ Turno expirado y limpiado. Nuevo turno permitido.');
                    // Limpiar URL sin recargar
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return false;
                } else {
                    // No ha pasado el tiempo suficiente
                    const minutosRestantes = Math.ceil(EXPIRATION_MINUTES - ((new Date().getTime() - new Date(turnoData.timestamp).getTime()) / (1000 * 60)));
                    mostrarAlerta(`‚è±Ô∏è Debe esperar ${minutosRestantes} minuto(s) m√°s antes de solicitar un nuevo turno.`, 'error');
                    mostrarResultado(turnoData.turnoId, null);
                    return true;
                }
            }
            
            // Sin par√°metro de reset, verificar expiraci√≥n autom√°tica
            if (turnoHaExpirado(turnoData.timestamp)) {
                localStorage.removeItem(TURNO_STORAGE_KEY);
                return false;
            }
            
            // Turno v√°lido, mostrarlo
            mostrarResultado(turnoData.turnoId, null);
            
            // Programar cierre autom√°tico para el tiempo restante
            const tiempoTranscurrido = (new Date().getTime() - new Date(turnoData.timestamp).getTime()) / (1000 * 60);
            const tiempoRestante = EXPIRATION_MINUTES - tiempoTranscurrido;
            if (tiempoRestante > 0) {
                programarCierreAutomatico(tiempoRestante);
            }
            
            return true;
        }
    } catch (error) {
        console.error('Error al recuperar turno guardado:', error);
        localStorage.removeItem(TURNO_STORAGE_KEY);
    }
    return false;
}

// Guardar turno en localStorage
function guardarTurno(turnoId) {
    try {
        const turnoData = {
            turnoId: turnoId,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(TURNO_STORAGE_KEY, JSON.stringify(turnoData));
        
        // Programar cierre autom√°tico despu√©s de la expiraci√≥n
        programarCierreAutomatico();
    } catch (error) {
        console.error('Error al guardar turno:', error);
    }
}

// Programar cierre autom√°tico de la ventana cuando expire el turno
function programarCierreAutomatico(minutosCustom) {
    const minutos = minutosCustom || EXPIRATION_MINUTES;
    const milisegundos = minutos * 60 * 1000;
    
    setTimeout(() => {
        console.log('‚è∞ Tiempo de turno expirado. Cerrando ventana...');
        
        // Limpiar localStorage
        localStorage.removeItem(TURNO_STORAGE_KEY);
        
        // Intentar cerrar la ventana
        const cerrado = window.close();
        
        // Si no se pudo cerrar (la ventana no fue abierta por JS)
        if (!cerrado) {
            // Mostrar mensaje amigable
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    background: linear-gradient(135deg, #0f172a, #1d4ed8 45%, #7c3aed);
                    color: white;
                    text-align: center;
                    padding: 20px;
                    font-family: system-ui, sans-serif;
                ">
                    <div style="
                        background: rgba(255, 255, 255, 0.95);
                        padding: 40px;
                        border-radius: 24px;
                        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
                        color: #0f172a;
                        max-width: 500px;
                    ">
                        <div style="font-size: 60px; margin-bottom: 20px;">‚úÖ</div>
                        <h1 style="margin-bottom: 16px; font-size: 24px;">Sesi√≥n Finalizada</h1>
                        <p style="margin-bottom: 20px; color: #475569; line-height: 1.6;">
                            Tu turno ha sido procesado. Gracias por usar nuestro sistema.
                        </p>
                        <p style="font-size: 14px; color: #64748b;">
                            Puedes cerrar esta ventana de forma segura.
                        </p>
                    </div>
                </div>
            `;
        }
    }, milisegundos);
    
    console.log(`‚è∞ Cierre autom√°tico programado en ${minutos.toFixed(1)} minutos`);
}

// Verificar token de acceso en la URL
async function verificarAcceso() {
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get('access');

    if (!accessToken) {
        console.warn('üö´ Acceso denegado: No hay token de acceso');
        mostrarAccesoDenegado();
        return false;
    }

    try {
        const response = await fetch(`/api/token/verificar-acceso/${encodeURIComponent(accessToken)}`);
        const data = await response.json();

        if (!data.success) {
            console.warn('üö´ Acceso denegado: Token inv√°lido o expirado');
            mostrarAccesoDenegado();
            return false;
        }

        console.log('‚úÖ Token de acceso v√°lido');
        return true;
    } catch (error) {
        console.error('‚ùå Error verificando acceso:', error);
        mostrarAccesoDenegado();
        return false;
    }
}

// Mostrar mensaje de acceso denegado
function mostrarAccesoDenegado() {
    document.body.innerHTML = `
        <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            min-height: 100vh;
            background: radial-gradient(circle at top, rgba(59, 130, 246, 0.28), transparent 55%),
                        linear-gradient(135deg, #0f172a, #1d4ed8 45%, #7c3aed);
            background-attachment: fixed;
            color: white;
            text-align: center;
            padding: 40px 20px 20px;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
        ">
            <img 
                src="https://www.chevyplan.com.ec/wp-content/uploads/2025/10/wb_chevyplan_logo-financiamiento-w_v5.webp" 
                alt="ChevyPlan Logo" 
                style="max-width: 220px; height: auto; margin-bottom: 32px; filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));"
            >
            <div style="
                background: rgba(255, 255, 255, 0.96);
                backdrop-filter: blur(20px);
                padding: 48px;
                border-radius: 24px;
                border: 1px solid rgba(148, 163, 184, 0.35);
                box-shadow: 0 24px 48px rgba(15, 23, 42, 0.25);
                color: #0f172a;
                max-width: 500px;
            ">
                <div style="font-size: 64px; margin-bottom: 24px;">üîí</div>
                <h1 style="margin-bottom: 16px; font-size: 28px; font-weight: 700;">Acceso Restringido</h1>
                <p style="margin-bottom: 0; color: #475569; line-height: 1.6; font-size: 16px;">
                    Esta p√°gina solo es accesible mediante c√≥digo QR. Por favor, escanea el c√≥digo QR proporcionado en nuestras oficinas para solicitar un turno.
                </p>
            </div>
        </div>
    `;
}

// Validar c√©dula ecuatoriana (algoritmo del m√≥dulo 10)
function validarCedulaEcuatoriana(cedula) {
    if (!/^\d{10}$/.test(cedula)) {
        return false;
    }

    const provincia = parseInt(cedula.substring(0, 2), 10);
    if (provincia < 1 || provincia > 24) {
        return false;
    }

    const tercerDigito = parseInt(cedula.charAt(2), 10);
    if (tercerDigito >= 6) {
        return false;
    }

    const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
    const digitoVerificador = parseInt(cedula.charAt(9), 10);
    let suma = 0;

    for (let i = 0; i < 9; i++) {
        let valor = parseInt(cedula.charAt(i), 10) * coeficientes[i];
        if (valor >= 10) {
            valor -= 9;
        }
        suma += valor;
    }

    const resultado = suma % 10;
    const digitoEsperado = resultado === 0 ? 0 : 10 - resultado;

    return digitoVerificador === digitoEsperado;
}

// Validar n√∫mero de identificaci√≥n (c√©dula, RUC o pasaporte)
function validarIdentificacion(identificacion) {
    const limpio = identificacion.trim().toUpperCase();

    if (/[A-Z]/.test(limpio)) {
        if (limpio.length >= 5) {
            return { valido: true, tipo: 'pasaporte' };
        }
        return { valido: false, mensaje: 'El pasaporte debe tener al menos 5 caracteres.' };
    }

    if (/^\d+$/.test(limpio)) {
        if (limpio.length === 13) {
            const cedula = limpio.substring(0, 10);
            const establecimiento = limpio.substring(10, 13);
            
            if (establecimiento !== '001') {
                return { valido: false, mensaje: 'El RUC debe terminar en 001.' };
            }
            
            if (!validarCedulaEcuatoriana(cedula)) {
                return { valido: false, mensaje: 'El RUC contiene una c√©dula inv√°lida.' };
            }
            
            return { valido: true, tipo: 'ruc' };
        }
        
        if (limpio.length === 10) {
            if (!validarCedulaEcuatoriana(limpio)) {
                return { valido: false, mensaje: 'La c√©dula ecuatoriana no es v√°lida.' };
            }
            return { valido: true, tipo: 'cedula' };
        }
        
        return { valido: false, mensaje: 'La c√©dula debe tener 10 d√≠gitos o el RUC 13 d√≠gitos.' };
    }

    return { valido: false, mensaje: 'Formato de identificaci√≥n no v√°lido.' };
}

// Validar si el n√∫mero tiene WhatsApp usando Evolution API
async function validarWhatsApp(celular) {
    try {
        if (!WHATSAPP_API_URL || !WHATSAPP_API_TOKEN) {
            console.warn('‚ö†Ô∏è WhatsApp API no configurada, omitiendo validaci√≥n');
            return { valido: true, advertencia: true };
        }

        const numeroLimpio = celular.replace(/[\s\-\(\)]/g, '');
        const numeroConPais = '593' + numeroLimpio;

        console.log('üîç Validando WhatsApp para:', numeroConPais);

        const response = await fetch(WHATSAPP_API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': WHATSAPP_API_TOKEN
            },
            body: JSON.stringify({
                numbers: [numeroConPais]
            })
        });

        if (!response.ok) {
            console.warn('‚ö†Ô∏è No se pudo validar WhatsApp, continuando sin validaci√≥n');
            return { valido: true, advertencia: true };
        }

        const resultado = await response.json();
        console.log('üì± Respuesta de validaci√≥n WhatsApp:', resultado);

        if (resultado && Array.isArray(resultado) && resultado.length > 0) {
            const numeroValidado = resultado[0];
            
            // SOLO validar con la propiedad "exists"
            // jid existe en la respuesta incluso cuando exists=false, por eso NO lo usamos
            if (numeroValidado.exists === true) {
                console.log('‚úÖ N√∫mero con WhatsApp confirmado');
                return { valido: true, numeroWhatsApp: numeroConPais };
            } else {
                console.log('‚ùå N√∫mero sin WhatsApp detectado');
                return { 
                    valido: false, 
                    mensaje: 'El n√∫mero de celular no tiene WhatsApp activo. Por favor ingresa un n√∫mero v√°lido con WhatsApp.'
                };
            }
        }

        console.warn('‚ö†Ô∏è Respuesta inesperada de la API, continuando sin validaci√≥n estricta');
        return { valido: true, advertencia: true };

    } catch (error) {
        console.error('‚ùå Error al validar WhatsApp:', error);
        return { valido: true, advertencia: true };
    }
}

// Enviar datos (simulaci√≥n)
async function enviarAN8N(datos, aceptoTerminos) {
    const payload = {
        numero_cedula: datos.cedula,
        numero_celular: datos.celular,
        acepto_terminos: aceptoTerminos,
        timestamp: new Date().toISOString(),
        origen: 'formulario_web'
    };

    console.log('Datos que se enviarian a n8n:', payload);

    await new Promise(resolve => setTimeout(resolve, 2000));

    const numeroAleatorio = Math.floor(Math.random() * 999) + 1;
    const turnoId = 'T' + numeroAleatorio.toString().padStart(3, '0');
    
    return {
        success: true,
        turno_id: turnoId,
        message: 'Turno creado exitosamente'
    };
}

// Cargar configuraci√≥n p√∫blica del servidor
async function cargarConfigPublica() {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);

        const respuesta = await fetch(PUBLIC_CONFIG_ENDPOINT, { 
            cache: 'no-store',
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!respuesta.ok) {
            throw new Error('Respuesta inv√°lida de configuraci√≥n');
        }

        const data = await respuesta.json();
        
        if (logoImg) {
            const logoUrl = typeof data.logoUrl === 'string' && data.logoUrl.trim().length > 0
                ? data.logoUrl.trim()
                : DEFAULT_LOGO_URL;

            logoImg.src = logoUrl;
            logoImg.onerror = function() {
                console.warn('Error cargando logo desde URL configurada, usando fallback');
                logoImg.src = DEFAULT_LOGO_URL;
            };
        }
        
        if (data.resetParam) {
            RESET_PARAM = data.resetParam;
            console.log('üîß Par√°metro de reset configurado:', RESET_PARAM);
        }
        
        if (data.expirationMinutes) {
            EXPIRATION_MINUTES = data.expirationMinutes;
            console.log('‚è±Ô∏è Tiempo de expiraci√≥n configurado:', EXPIRATION_MINUTES, 'minutos');
        }

        if (data.whatsappApiUrl) {
            WHATSAPP_API_URL = data.whatsappApiUrl;
            console.log('üì± WhatsApp API URL configurada:', WHATSAPP_API_URL);
        } else {
            console.warn('‚ö†Ô∏è WhatsApp API URL no encontrada en configuraci√≥n');
        }
        
        if (data.whatsappApiToken) {
            WHATSAPP_API_TOKEN = data.whatsappApiToken;
            console.log('üîë WhatsApp API Token configurado:', WHATSAPP_API_TOKEN.substring(0, 10) + '...');
        } else {
            console.warn('‚ö†Ô∏è WhatsApp API Token no encontrado en configuraci√≥n');
        }
    } catch (error) {
        console.error('Error cargando configuraci√≥n p√∫blica:', error);
        if (logoImg) {
            logoImg.src = DEFAULT_LOGO_URL;
        }
    }
}

// Establecer estado de procesamiento
function setProcessing(isProcessing) {
    if (formShell) {
        formShell.classList.toggle('is-loading', isProcessing);
    }
    if (loading) {
        loading.classList.toggle('visible', isProcessing);
    }
    if (submitBtn) {
        submitBtn.disabled = isProcessing;
    }
    if (isProcessing) {
        form.setAttribute('aria-busy', 'true');
    } else {
        form.removeAttribute('aria-busy');
    }
}

// Mostrar resultado del turno
function mostrarResultado(turnoId, datos) {
    if (headerElement) {
        headerElement.classList.add('hidden');
    }
    
    if (formShell) {
        formShell.classList.remove('visible');
        formShell.classList.add('hidden');
    }
    if (successMessage) {
        successMessage.classList.remove('hidden');
        successMessage.classList.add('visible');
    }
    
    if (turnoId && turnoIdElemento) {
        turnoIdElemento.textContent = turnoId;
        guardarTurno(turnoId);
    } else {
        turnoIdElemento.textContent = 'N/A';
    }
    
    if (alertContainer) {
        alertContainer.innerHTML = '';
    }
    form.reset();
    
    if (cedulaInput) cedulaInput.classList.remove('error', 'success');
    if (celularInput) celularInput.classList.remove('error', 'success');
}

// Mostrar alerta
function mostrarAlerta(mensaje, tipo) {
    if (!alertContainer) {
        return;
    }
    const alerta = document.createElement('div');
    alerta.className = 'alert alert-' + tipo;
    alerta.setAttribute('role', tipo === 'error' ? 'alert' : 'status');
    alerta.textContent = mensaje;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alerta);
}

// Inicializar aplicaci√≥n
(async function inicializar() {
    const accesoValido = await verificarAcceso();
    if (!accesoValido) {
        return;
    }

    await cargarConfigPublica();
    
    const hayTurnoGuardado = verificarTurnoGuardado();

    if (!hayTurnoGuardado && cedulaInput) {
        cedulaInput.focus();
    }
})();

// Event Listeners
form.addEventListener('submit', async function (event) {
    event.preventDefault();
    
    const now = Date.now();
    if (now - lastSubmitTime < RATE_LIMIT_MS) {
        const remaining = Math.ceil((RATE_LIMIT_MS - (now - lastSubmitTime)) / 1000);
        mostrarAlerta(`Por favor espera ${remaining} segundo(s) antes de enviar otra solicitud.`, 'error');
        return;
    }

    const formData = new FormData(form);
    const datos = {
        cedula: (formData.get('cedula') || '').toString().trim(),
        celular: (formData.get('celular') || '').toString().trim()
    };

    const aceptoTerminosCheckbox = document.getElementById('aceptoTerminos');
    const aceptoTerminos = aceptoTerminosCheckbox instanceof HTMLInputElement
        ? aceptoTerminosCheckbox.checked
        : false;

    if (cedulaInput) cedulaInput.classList.remove('error', 'success');
    if (celularInput) celularInput.classList.remove('error', 'success');

    if (!datos.cedula || !datos.celular) {
        mostrarAlerta('Todos los campos son obligatorios.', 'error');
        if (!datos.cedula && cedulaInput) cedulaInput.classList.add('error');
        if (!datos.celular && celularInput) celularInput.classList.add('error');
        return;
    }

    if (!aceptoTerminos) {
        mostrarAlerta('Debes autorizar el tratamiento de datos para continuar.', 'error');
        return;
    }

    const validacionId = validarIdentificacion(datos.cedula);
    if (!validacionId.valido) {
        mostrarAlerta(validacionId.mensaje, 'error');
        if (cedulaInput) cedulaInput.classList.add('error');
        return;
    }

    console.log(`‚úÖ Identificaci√≥n v√°lida - Tipo: ${validacionId.tipo}`);

    const celularLimpio = datos.celular.replace(/[\s\-\(\)]/g, '');
    
    if (!/^\d{10}$/.test(celularLimpio) && !/^3\d{9}$/.test(celularLimpio)) {
        mostrarAlerta('Ingresa un n√∫mero de celular v√°lido con 10 d√≠gitos.', 'error');
        if (celularInput) celularInput.classList.add('error');
        return;
    }
    
    setProcessing(true);
    mostrarAlerta('Validando n√∫mero de WhatsApp...', 'info');
    
    const validacionWhatsApp = await validarWhatsApp(datos.celular);
    
    if (!validacionWhatsApp.valido) {
        mostrarAlerta(validacionWhatsApp.mensaje || 'El n√∫mero no tiene WhatsApp activo.', 'error');
        if (celularInput) celularInput.classList.add('error');
        setProcessing(false);
        return;
    }

    if (validacionWhatsApp.advertencia) {
        console.warn('‚ö†Ô∏è Continuando sin validaci√≥n estricta de WhatsApp');
    }

    if (cedulaInput) cedulaInput.classList.add('success');
    if (celularInput) celularInput.classList.add('success');

    lastSubmitTime = now;

    try {
        const resultado = await enviarAN8N(datos, aceptoTerminos);
        const turnoId = resultado && resultado.success ? resultado.turno_id : null;
        
        if (turnoId) {
            const tokenResponse = await fetch('/api/token/generar-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    turnoId: turnoId,
                    cedula: datos.cedula,
                    celular: datos.celular
                })
            });

            if (tokenResponse.ok) {
                const tokenData = await tokenResponse.json();
                window.location.replace('/confirmacion?token=' + tokenData.token);
            } else {
                console.error('Error generando token de seguridad');
                mostrarAlerta('Error generando token de seguridad.', 'error');
                setProcessing(false);
            }
        } else {
            mostrarAlerta('No se pudo obtener el n√∫mero de turno.', 'error');
            setProcessing(false);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('No pudimos procesar la solicitud. Intenta de nuevo en unos segundos.', 'error');
        setProcessing(false);
    }
});

// Event listeners para validaci√≥n en tiempo real
if (cedulaInput) {
    cedulaInput.addEventListener('input', function (event) {
        event.target.value = event.target.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase();
        
        const valor = event.target.value;
        cedulaInput.classList.remove('error', 'success');
        
        if (valor.length >= 5) {
            cedulaInput.classList.add('success');
        }
    });
    
    cedulaInput.addEventListener('blur', function(event) {
        const valor = event.target.value.trim();
        cedulaInput.classList.remove('error', 'success');
        
        if (valor.length > 0) {
            const validacion = validarIdentificacion(valor);
            if (validacion.valido) {
                cedulaInput.classList.add('success');
            } else {
                cedulaInput.classList.add('error');
            }
        }
    });
}

if (celularInput) {
    celularInput.addEventListener('input', function (event) {
        event.target.value = event.target.value.replace(/[^\d\s\-]/g, '');
        
        const valor = event.target.value;
        const limpio = valor.replace(/[\s\-\(\)]/g, '');
        celularInput.classList.remove('error', 'success');
        
        if (limpio.length === 10 && /^\d{10}$/.test(limpio)) {
            celularInput.classList.add('success');
        } else if (limpio.length > 10) {
            celularInput.classList.add('error');
        }
    });
    
    celularInput.addEventListener('blur', function(event) {
        const valor = event.target.value.trim();
        const limpio = valor.replace(/[\s\-\(\)]/g, '');
        celularInput.classList.remove('error', 'success');
        
        if (limpio.length > 0) {
            if (limpio.length === 10 && /^\d{10}$/.test(limpio)) {
                celularInput.classList.add('success');
            } else {
                celularInput.classList.add('error');
            }
        }
    });
}
